{"version":3,"sources":["../../src/rules/noUndefinedTypes.js"],"names":["extraTypes","stripPseudoTypes","str","replace","context","report","settings","sourceCode","scopeManager","utils","globalScope","definedTypes","options","definedPreferredTypes","preferredTypes","Object","keys","length","_","values","map","preferredType","undefined","reportSettings","replacement","filter","typedefDeclarations","getAllComments","comment","value","startsWith","parseComment","flatMap","doc","tags","tag","isNamepathDefiningTag","name","templateTags","getPresentTags","classJsdoc","getClassJsdoc","concat","closureGenericTypes","jsdocUtils","parseClosureTemplateTag","allDefinedTypes","Set","variables","__options","nodejsScope","isModule","childScopes","mode","jsdocTagsWithPossibleType","filterTags","tagMightHaveTypePosition","forEach","parsedType","type","has","includes","markVariableAsUsed","iterateAllJsdocs","meta","schema","additionalProperties","properties","items"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport {parse as parseType, traverse} from 'jsdoctypeparser';\nimport iterateJsdoc, {parseComment} from '../iterateJsdoc';\nimport jsdocUtils from '../jsdocUtils';\n\nconst extraTypes = [\n  'null', 'undefined', 'void', 'string', 'boolean', 'object',\n  'function', 'symbol',\n  'number', 'bigint', 'NaN', 'Infinity',\n  'any', '*',\n  'Array', 'Object', 'RegExp', 'Date', 'Function',\n];\n\nconst stripPseudoTypes = (str) => {\n  return str && str.replace(/(?:\\.|<>|\\.<>|\\[\\])$/u, '');\n};\n\nexport default iterateJsdoc(({\n  context,\n  report,\n  settings,\n  sourceCode: {scopeManager},\n  utils,\n}) => {\n  const {globalScope} = scopeManager;\n\n  const {definedTypes = []} = context.options[0] || {};\n\n  let definedPreferredTypes = [];\n  const {preferredTypes} = settings;\n  if (Object.keys(preferredTypes).length) {\n    // Replace `_.values` with `Object.values` when we may start requiring Node 7+\n    definedPreferredTypes = _.values(preferredTypes).map((preferredType) => {\n      if (typeof preferredType === 'string') {\n        // May become an empty string but will be filtered out below\n        return stripPseudoTypes(preferredType);\n      }\n      if (!preferredType) {\n        return undefined;\n      }\n      if (typeof preferredType !== 'object') {\n        utils.reportSettings(\n          'Invalid `settings.jsdoc.preferredTypes`. Values must be falsy, a string, or an object.',\n        );\n      }\n\n      return stripPseudoTypes(preferredType.replacement);\n    }).filter((preferredType) => {\n      return preferredType;\n    });\n  }\n\n  const typedefDeclarations = _(context.getAllComments())\n    .filter((comment) => {\n      return comment.value.startsWith('*');\n    })\n    .map(parseComment)\n    .flatMap((doc) => {\n      return (doc.tags || []).filter(({tag}) => {\n        return utils.isNamepathDefiningTag(tag);\n      });\n    })\n    .map((tag) => {\n      return tag.name;\n    })\n    .value();\n\n  let templateTags = utils.getPresentTags('template');\n  const classJsdoc = utils.getClassJsdoc();\n  if (classJsdoc?.tags) {\n    templateTags = templateTags.concat(\n      classJsdoc.tags\n        .filter(({tag}) => {\n          return tag === 'template';\n        }),\n    );\n  }\n\n  const closureGenericTypes = _.flatMap(templateTags, (tag) => {\n    return jsdocUtils.parseClosureTemplateTag(tag);\n  });\n\n  const allDefinedTypes = new Set(globalScope.variables.map(({name}) => {\n    return name;\n  })\n\n    // If the file is a module, concat the variables from the module scope.\n    .concat(\n\n      // This covers `commonjs` as well as `node`\n      scopeManager.__options.nodejsScope ||\n      scopeManager.isModule() ?\n        _.flatMap(globalScope.childScopes, ({variables}) => {\n          return variables;\n        }, []).map(({name}) => {\n          return name;\n        }) : [],\n    )\n    .concat(extraTypes)\n    .concat(typedefDeclarations)\n    .concat(definedTypes)\n    .concat(definedPreferredTypes)\n    .concat(settings.mode === 'jsdoc' ? [] : closureGenericTypes));\n\n  const jsdocTagsWithPossibleType = utils.filterTags(({tag}) => {\n    return utils.tagMightHaveTypePosition(tag);\n  });\n\n  jsdocTagsWithPossibleType.forEach((tag) => {\n    let parsedType;\n\n    try {\n      parsedType = parseType(tag.type);\n    } catch {\n      // On syntax error, will be handled by valid-types.\n      return;\n    }\n\n    traverse(parsedType, ({type, name}) => {\n      if (type === 'NAME') {\n        if (!allDefinedTypes.has(name)) {\n          report(`The type '${name}' is undefined.`, null, tag);\n        } else if (!_.includes(extraTypes, name)) {\n          context.markVariableAsUsed(name);\n        }\n      }\n    });\n  });\n}, {\n  iterateAllJsdocs: true,\n  meta: {\n    schema: [\n      {\n        additionalProperties: false,\n        properties: {\n          definedTypes: {\n            items: {\n              type: 'string',\n            },\n            type: 'array',\n          },\n        },\n        type: 'object',\n      },\n    ],\n    type: 'suggestion',\n  },\n});\n"],"file":"noUndefinedTypes.js"}